<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë°˜ì‘í˜• ìŒì–‘ë ¥ ë‹¬ë ¥ ë° ì•Œë¦¼</title>
    
    <!-- PWA ë° ëª¨ë°”ì¼ ì•± ì„¤ì • -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- PWA Manifest (Data URI) -->
    <link rel="manifest" id="manifest-placeholder">
    <script>
        const manifest = {
            "name": "ìŒì–‘ë ¥ ìŠ¤ë§ˆíŠ¸ ë‹¬ë ¥",
            "short_name": "ìŠ¤ë§ˆíŠ¸ë‹¬ë ¥",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f7f9fb",
            "theme_color": "#4f46e5",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/2693/2693507.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');

        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • ë° ìŠ¤í¬ë¡¤ ë°©ì§€ */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            color: #1f2937;
            /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
            -webkit-tap-highlight-color: transparent;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆì— ì•½ê°„ì˜ íŒ¨ë”© ì¶”ê°€ */
        #calendar-app {
            position: relative;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë‹¬ë ¥ ì…€ í¬ê¸° ì¡°ì • */
        .day-cell {
            aspect-ratio: 1 / 1; /* ì •ì‚¬ê°í˜• ìœ ì§€ */
            display: flex;
            flex-direction: column;
            padding: 4px;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ì„œ ë³€ê²½ */
            user-select: none;
            transition: all 0.2s ease;
            position: relative; /* ë©”ëª¨/ì•Œë¦¼ í‘œì‹œë¥¼ ìœ„í•´ í•„ìš” */
            border: 1px solid transparent;
        }

        .day-cell:hover {
            background-color: #eef2ff; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì—°í•œ ë³´ë¼ìƒ‰ ë°°ê²½ */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        /* ì˜¤ëŠ˜ ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸ */
        .today {
            background-color: #fff7ed; /* orange-50 */
            border: 2px solid #f97316; /* orange-500 */
        }
        
        /* ì„ íƒëœ ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸ */
        .selected-date {
            background-color: #f0f9ff; /* sky-50 */
            border: 2px solid #0ea5e9; /* sky-500 */
        }

        /* ê³µíœ´ì¼/ê¸°ë…ì¼ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .commemoration-text {
            color: #ef4444; /* Tailwind red-500 */
            font-weight: 700;
        }
        
        /* ë©”ëª¨/ì•Œë¦¼ í‘œì‹œ ì•„ì´ì½˜ ì»¨í…Œì´ë„ˆ */
        .memo-icons {
            position: absolute;
            top: 6px;
            left: 6px;
            display: flex;
            gap: 3px;
        }
        
        /* ë©”ëª¨ í‘œì‹œ ì  ìŠ¤íƒ€ì¼ */
        .memo-dot, .alarm-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .memo-dot {
            background-color: #4f46e5; /* primary color (ë©”ëª¨) */
        }

        .alarm-icon {
            background-color: #ef4444; /* red (ì•Œë¦¼) */
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* ëª¨ë‹¬ ë°°ê²½ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ */
        #notification-box {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 350px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-item {
            animation: slideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ì„¤ì¹˜ ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ */
        #installAppBtn {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        /* ì•Œë¦¼ ë°°ì§€ */
        #storage-mode-indicator {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // ë³´ë¼ìƒ‰
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="notification-box">
        <!-- ì•Œë¦¼ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
    </div>

    <div id="calendar-app" class="bg-white rounded-2xl shadow-xl p-4 sm:p-8 w-full max-w-4xl border border-gray-100">
        
        <!-- ë‹¬ë ¥ í—¤ë” (ì›” ì´ë™ ë° í˜„ì¬ ì›” í‘œì‹œ) -->
        <div class="flex flex-col mb-8">
            <div class="flex justify-between items-center mb-2">
                <button id="prevMonth" class="p-3 rounded-full hover:bg-gray-100 transition-colors text-gray-600 hover:text-primary active:scale-95 transform transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div class="text-center">
                    <div class="flex items-center justify-center">
                        <h2 id="currentMonthYear" class="text-3xl sm:text-4xl font-extrabold text-gray-800 tracking-tight cursor-pointer hover:text-primary transition-colors" title="ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ë™" onclick="goToday()"></h2>
                    </div>
                    <!-- ë‚˜ì´ í‘œì‹œ ì˜ì—­ -->
                    <div id="ageDisplay" class="mt-2 text-sm font-semibold text-primary bg-indigo-50 px-3 py-1 rounded-full inline-block hidden">
                        <!-- JSë¡œ ë‚´ìš© ì±„ì›€: ë§Œ 00ì„¸ (í•œêµ­ë‚˜ì´ 00ì„¸) -->
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- ì•± ì„¤ì¹˜ ë²„íŠ¼ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
                    <button id="installAppBtn" class="hidden p-3 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition-colors" title="ì•±ìœ¼ë¡œ ì„¤ì¹˜">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                    
                    <button id="profileBtn" class="p-3 rounded-full hover:bg-gray-100 transition-colors text-gray-600 hover:text-primary" title="ìƒë…„ì›”ì¼ ì„¤ì •">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </button>
                    <button id="nextMonth" class="p-3 rounded-full hover:bg-gray-100 transition-colors text-gray-600 hover:text-primary active:scale-95 transform transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- ìš”ì¼ í—¤ë” -->
        <div class="grid grid-cols-7 text-center font-bold text-base sm:text-lg border-b border-gray-200 pb-4 mb-4">
            <div class="text-red-500">ì¼</div> <!-- ì¼ìš”ì¼: ë¹¨ê°„ìƒ‰ -->
            <div class="text-gray-500">ì›”</div>
            <div class="text-gray-500">í™”</div>
            <div class="text-gray-500">ìˆ˜</div>
            <div class="text-gray-500">ëª©</div>
            <div class="text-gray-500">ê¸ˆ</div>
            <div class="text-blue-500">í† </div> <!-- í† ìš”ì¼: íŒŒë€ìƒ‰ -->
        </div>

        <!-- ë‚ ì§œ ê·¸ë¦¬ë“œ -->
        <div id="calendarGrid" class="grid grid-cols-7 gap-2">
            <!-- ë‚ ì§œ ì…€ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤. -->
        </div>
        
        <!-- ìœ„ì ¯ ì„¹ì…˜ -->
        <div id="widgets" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- ìœ„ì ¯ 1: ì„ íƒëœ ë‚ ì§œ ì •ë³´ ë° ë©”ëª¨ í‘œì‹œ -->
            <div id="todayWidget" class="bg-white p-6 border border-gray-100 rounded-2xl shadow-lg transition hover:shadow-xl">
                <h3 class="text-xl font-bold text-primary mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    ì„ íƒëœ ë‚ ì§œ
                </h3>
                <div class="mb-5">
                    <p class="text-gray-900 text-3xl sm:text-4xl font-bold mb-1 tracking-tight" id="todaySolarDate"></p>
                    <p class="text-gray-500 text-base sm:text-lg font-medium" id="todayLunarDate"></p>
                    <p class="mt-3 text-lg sm:text-xl font-bold" id="todayCommemoration"></p>
                </div>
                
                <div class="border-t border-gray-100 pt-5 mt-4">
                    <h4 class="text-base font-semibold text-gray-500 mb-3 flex items-center justify-between">
                        <span class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                            ë©”ëª¨
                        </span>
                        <span class="text-xs sm:text-sm text-primary bg-primary/10 px-3 py-1 rounded-full cursor-pointer hover:bg-primary/20 transition" onclick="triggerMemoModal()">ì‘ì„±í•˜ê¸°</span>
                    </h4>
                    <div class="bg-gray-50 p-5 rounded-xl min-h-[6rem] group relative">
                         <p id="selectedDateMemo" class="text-gray-700 whitespace-pre-wrap text-base leading-relaxed"></p>
                         <p id="selectedDateReminder" class="text-sm mt-3 font-semibold text-red-500 flex items-center"></p>
                    </div>
                </div>
            </div>

            <!-- ìœ„ì ¯ 2: ë‹¤ìŒ ê³µíœ´ì¼ (ì„ íƒëœ ë‚ ì§œ ê¸°ì¤€) -->
            <div id="nextHolidayWidget" class="bg-gradient-to-br from-primary/5 to-white p-6 border border-primary/10 rounded-2xl shadow-lg transition hover:shadow-xl">
                <h3 class="text-xl font-bold text-primary mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ë‹¤ê°€ì˜¤ëŠ” ê³µíœ´ì¼
                </h3>
                <div class="flex flex-col justify-center h-56">
                    <p class="text-gray-900 text-3xl sm:text-5xl font-extrabold mb-3 leading-tight" id="nextCommemorationName"></p>
                    <p class="text-gray-600 text-xl font-medium" id="nextCommemorationDate"></p>
                    <div class="mt-5 inline-flex items-center text-base font-medium">
                        <span id="dDayCount" class="bg-red-100 text-red-600 px-4 py-1.5 rounded-full font-bold text-sm">D-Day</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„¤ëª… -->
        <div class="mt-8 text-sm text-gray-500 border-t border-gray-100 pt-4 flex flex-wrap gap-4 justify-center font-medium">
            <div class="flex items-center"><span class="w-4 h-4 bg-red-100 border border-red-500 rounded-full mr-2"></span> ì¼ìš”ì¼/ê³µíœ´ì¼</div>
            <div class="flex items-center"><span class="w-4 h-4 bg-blue-100 border border-blue-500 rounded-full mr-2"></span> í† ìš”ì¼</div>
            <div class="flex items-center"><span class="w-4 h-4 bg-white border border-gray-300 rounded-full mr-2"></span> í‰ì¼</div>
            <div class="flex items-center"><span class="w-3 h-3 bg-primary rounded-full mr-2"></span> ë©”ëª¨ ìˆìŒ</div>
            <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span> ì•Œë¦¼ ì„¤ì •</div>
        </div>

        <!-- ê´‘ê³  ì˜ì—­ ì¶”ê°€ -->
        <div class="mt-8 w-full border-t border-gray-100 pt-6 pb-2">
            <!-- ê´‘ê³  ì»¨í…Œì´ë„ˆ: ì‹¤ì œ ë°°í¬ ì‹œ border-dashed ë“± ìŠ¤íƒ€ì¼ì€ ì œê±°í•´ë„ ë©ë‹ˆë‹¤ -->
            <div id="ad-banner" class="w-full bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 min-h-[100px] flex flex-col justify-center items-center overflow-hidden relative">
                
                <!-- 1. ì• ë“œì„¼ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ (ì´ë¯¸ ì ìš©ë¨) -->
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7339124211140934"
                     crossorigin="anonymous"></script>
                
                <!-- 2. ê´‘ê³  ë‹¨ìœ„ (Ad Unit) ì„¤ì • -->
                <!-- 
                   [ì¤‘ìš”] ì•„ë˜ data-ad-slot="1234567890" ë¶€ë¶„ì„ 
                   ì• ë“œì„¼ìŠ¤ì—ì„œ ìƒˆë¡œ ë§Œë“  'ë””ìŠ¤í”Œë ˆì´ ê´‘ê³  ë‹¨ìœ„'ì˜ ID ìˆ«ìë¡œ ë°”ê¿”ì£¼ì„¸ìš”.
                -->
                <ins class="adsbygoogle"
                     style="display:block; width: 100%; height: 100%;"
                     data-ad-client="ca-pub-7339124211140934"
                     data-ad-slot="1234567890" 
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                
                <!-- 3. ê´‘ê³  í‘¸ì‹œ ìŠ¤í¬ë¦½íŠ¸ -->
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>

                <!-- (ì°¸ê³ ìš© í…ìŠ¤íŠ¸: ê´‘ê³ ê°€ ë¡œë“œë˜ë©´ ì´ í…ìŠ¤íŠ¸ëŠ” ê°€ë ¤ì§‘ë‹ˆë‹¤) -->
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0 opacity-30">
                    <p class="text-xs font-bold text-gray-400">AD AREA</p>
                    <p class="text-[10px] text-gray-400">data-ad-slot IDë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>

    </div>

    <!-- ë©”ëª¨ ì‘ì„± ëª¨ë‹¬ -->
    <div id="memoModal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-lg modal-content transform transition-all h-[90vh] overflow-y-auto sm:h-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="modalDateTitle"></h3>
                <button id="closeModalCross" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- ê³µíœ´ì¼ ì„¤ì • ì„¹ì…˜ -->
            <div class="mb-6 p-5 bg-red-50 rounded-xl border border-red-100">
                <div class="flex items-center justify-between mb-4">
                    <label for="isCustomHoliday" class="text-base font-bold text-red-500 flex items-center cursor-pointer select-none">
                        <input type="checkbox" id="isCustomHoliday" class="mr-3 w-5 h-5 text-red-500 rounded focus:ring-red-500 border-gray-300">
                        ê³µíœ´ì¼(ë¹¨ê°„ ë‚ )ë¡œ ì§€ì •
                    </label>
                </div>
                <input type="text" id="customHolidayName" class="w-full p-3 bg-white border border-red-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition outline-none text-base placeholder-red-200" placeholder="ê¸°ë…ì¼ ì´ë¦„ (ì˜ˆ: ê²°í˜¼ê¸°ë…ì¼)">
            </div>

            <div class="mb-6">
                <label for="reminderTime" class="block text-base font-bold text-gray-700 mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ì•Œë¦¼ ì‹œê°„ ì„¤ì • (ì„ íƒ)
                </label>
                <input type="time" id="reminderTime" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition outline-none text-base">
            </div>

            <div class="mb-8">
                <label for="memoInput" class="block text-base font-bold text-gray-700 mb-2">ë©”ëª¨ ë‚´ìš©</label>
                <textarea id="memoInput" rows="6" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent resize-none transition outline-none text-base leading-relaxed" placeholder="í•  ì¼ì´ë‚˜ ì¼ì •ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
            </div>
            
            <div class="flex justify-between items-center pt-2">
                <button id="deleteMemoBtn" class="px-5 py-2.5 text-red-500 text-base font-semibold hover:bg-red-50 rounded-lg transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    ì‚­ì œ
                </button>
                <div class="space-x-3">
                    <button id="closeMemoModalBtn" class="px-6 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors text-base">
                        ì·¨ì†Œ
                    </button>
                    <button id="saveMemoBtn" class="px-6 py-3 bg-primary text-white font-bold rounded-xl hover:bg-indigo-600 shadow-lg shadow-indigo-200 transition-all hover:shadow-indigo-300 transform active:scale-95 text-base">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒë…„ì›”ì¼ ì„¤ì • ëª¨ë‹¬ -->
    <div id="birthdateModal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-11/12 max-w-md modal-content text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
            <p class="text-gray-500 mb-6">ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ë©´ ë‹¬ë ¥ì—ì„œ ë‚˜ì´ë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.</p>
            
            <div class="mb-6 text-left">
                <label for="userBirthdate" class="block text-sm font-bold text-gray-700 mb-2">ìƒë…„ì›”ì¼</label>
                <input type="date" id="userBirthdate" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition outline-none text-lg">
            </div>
            
            <button id="saveBirthdateBtn" class="w-full px-6 py-3.5 bg-primary text-white font-bold rounded-xl hover:bg-indigo-600 shadow-lg shadow-indigo-200 transition-all hover:shadow-indigo-300 transform active:scale-95 text-base">
                ì„¤ì • ì™„ë£Œ
            </button>
            <button id="closeBirthdateModalBtn" class="mt-3 text-sm text-gray-400 hover:text-gray-600 underline">ë‹¤ìŒì— ì„¤ì •í•˜ê¸°</button>
        </div>
    </div>

    <!-- Firebase SDK ë° ë¡œì§ (Hybrid: Firebase + LocalStorage Fallback) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let db;
        let auth;
        window.userId = null;
        window.isAuthReady = false;
        window.memos = {}; 
        window.reminders = {}; 
        window.userBirthdate = null; // 'YYYY-MM-DD' ë¬¸ìì—´
        
        // ** í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ ì„¤ì • **
        // __firebase_config ë³€ìˆ˜ê°€ ìˆìœ¼ë©´(Canvas í™˜ê²½) Firebase ì‚¬ìš©, ì—†ìœ¼ë©´(Standalone HTML) LocalStorage ì‚¬ìš©
        const useLocalStorage = typeof __firebase_config === 'undefined';

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('installAppBtn');
            if(installBtn) installBtn.classList.remove('hidden');
        });

        // ì „ì—­ í•¨ìˆ˜: ë‚ ì§œ ê°ì²´ë¥¼ 'YYYY-MM-DD' ë¬¸ìì—´ë¡œ í¬ë§·
        window.formatDateKey = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        
        // DOM ìš”ì†Œë“¤
        const memoModal = document.getElementById('memoModal');
        const modalDateTitle = document.getElementById('modalDateTitle');
        const memoInput = document.getElementById('memoInput');
        const reminderTimeInput = document.getElementById('reminderTime');
        const isCustomHolidayInput = document.getElementById('isCustomHoliday');
        const customHolidayNameInput = document.getElementById('customHolidayName');
        const saveMemoBtn = document.getElementById('saveMemoBtn');
        const deleteMemoBtn = document.getElementById('deleteMemoBtn');
        const closeMemoModalBtn = document.getElementById('closeMemoModalBtn');
        const closeModalCross = document.getElementById('closeModalCross');
        const notificationBox = document.getElementById('notification-box');
        const birthdateModal = document.getElementById('birthdateModal');
        const userBirthdateInput = document.getElementById('userBirthdate');
        const saveBirthdateBtn = document.getElementById('saveBirthdateBtn');
        const closeBirthdateModalBtn = document.getElementById('closeBirthdateModalBtn');
        const profileBtn = document.getElementById('profileBtn');
        const installAppBtn = document.getElementById('installAppBtn');

        let currentEditingDateKey = null;

        // ì„¤ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        if(installAppBtn) {
            installAppBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installAppBtn.classList.add('hidden');
                }
            });
        }

        // ==========================================
        // Data Handling Abstraction (Firebase or LocalStorage)
        // ==========================================

        /**
         * ì‚¬ìš©ì í”„ë¡œí•„(ìƒë…„ì›”ì¼) ë¡œë“œ
         */
        function setupUserProfile() {
            if (useLocalStorage) {
                // LocalStorage Mode
                const savedBirthdate = localStorage.getItem('calendar_user_birthdate');
                if (savedBirthdate) {
                    window.userBirthdate = savedBirthdate;
                    if(window.updateHeader) window.updateHeader();
                } else {
                    birthdateModal.classList.add('active');
                }
            } else {
                // Firebase Mode
                if (!window.userId) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(db, `/artifacts/${appId}/users/${window.userId}`);

                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.birthdate) {
                            window.userBirthdate = data.birthdate;
                            if(window.updateHeader) window.updateHeader();
                        } else {
                            if (window.userBirthdate === null) birthdateModal.classList.add('active');
                        }
                    } else {
                        birthdateModal.classList.add('active');
                    }
                });
            }
        }

        /**
         * ìƒë…„ì›”ì¼ ì €ì¥
         */
        async function saveBirthdate(dateStr) {
            if (useLocalStorage) {
                // LocalStorage Mode
                localStorage.setItem('calendar_user_birthdate', dateStr);
                window.userBirthdate = dateStr;
                birthdateModal.classList.remove('active');
                if(window.updateHeader) window.updateHeader();
                showNotification("ì„¤ì • ì™„ë£Œ", "ìƒë…„ì›”ì¼ì´ ê¸°ê¸°ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "settings");
            } else {
                // Firebase Mode
                if (!window.userId) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(db, `/artifacts/${appId}/users/${window.userId}`);
                try {
                    await setDoc(userDocRef, { birthdate: dateStr }, { merge: true });
                    window.userBirthdate = dateStr;
                    birthdateModal.classList.remove('active');
                    if(window.updateHeader) window.updateHeader();
                    showNotification("ì„¤ì • ì™„ë£Œ", "ìƒë…„ì›”ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "settings");
                } catch (e) {
                    console.error("ìƒë…„ì›”ì¼ ì €ì¥ ì‹¤íŒ¨:", e);
                    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }

        /**
         * ë©”ëª¨ ë°ì´í„° ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ
         */
        function setupDataListener() {
            if (useLocalStorage) {
                // LocalStorage Mode: Load immediately
                const savedMemos = localStorage.getItem('calendar_memos');
                if (savedMemos) {
                    try {
                        window.memos = JSON.parse(savedMemos);
                        // Restore reminders status
                        for (const [id, data] of Object.entries(window.memos)) {
                            if (data.reminderTime && !window.reminders.hasOwnProperty(id)) {
                                window.reminders[id] = data.completed || false;
                            }
                        }
                    } catch (e) {
                        console.error("Local storage parse error", e);
                        window.memos = {};
                    }
                }
                if (window.generateCalendar) window.generateCalendar();
                if (window.updateWidgets) window.updateWidgets();
            } else {
                // Firebase Mode
                if (!window.userId) {
                    console.error("ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const path = `/artifacts/${appId}/users/${window.userId}/memos`;
                const memosRef = collection(db, path);
                
                onSnapshot(memosRef, (snapshot) => {
                    const newMemos = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.content || data.reminderTime || data.isCustomHoliday || data.customHolidayName) { 
                            newMemos[doc.id] = {
                                content: data.content || '',
                                reminderTime: data.reminderTime || '', 
                                completed: data.completed || false,
                                isCustomHoliday: data.isCustomHoliday || false,
                                customHolidayName: data.customHolidayName || ''
                            };
                            if (data.reminderTime && !window.reminders.hasOwnProperty(doc.id)) {
                                 window.reminders[doc.id] = data.completed || false;
                            } else if (!data.reminderTime) {
                                 delete window.reminders[doc.id];
                            }
                        }
                    });
                    window.memos = newMemos;
                    if (window.generateCalendar) window.generateCalendar(); 
                    if (window.updateWidgets) window.updateWidgets(); 
                }, (error) => {
                    console.error("Firestore ë©”ëª¨ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                });
            }
        }

        /**
         * ë©”ëª¨ ì €ì¥ í•¨ìˆ˜
         */
        async function saveMemoData(dateKey, content, reminderTime, isCustomHoliday, customHolidayName) {
            const trimmedContent = content.trim();
            const validTime = reminderTime.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/) ? reminderTime : '';
            const trimmedHolidayName = customHolidayName.trim();
            const shouldDelete = trimmedContent === "" && validTime === "" && !isCustomHoliday && trimmedHolidayName === "";

            if (useLocalStorage) {
                // LocalStorage Mode
                if (shouldDelete) {
                    delete window.memos[dateKey];
                    delete window.reminders[dateKey];
                    showNotification("ì‚­ì œ ì™„ë£Œ", "ë©”ëª¨ì™€ ì„¤ì •ì´ ê¸°ê¸°ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", dateKey);
                } else {
                    window.memos[dateKey] = {
                        content: trimmedContent,
                        reminderTime: validTime,
                        completed: false,
                        isCustomHoliday: isCustomHoliday,
                        customHolidayName: trimmedHolidayName,
                        updatedAt: new Date().toISOString()
                    };
                    window.reminders[dateKey] = false;
                    console.log(`ë©”ëª¨ ì €ì¥(ë¡œì»¬): ${dateKey}`);
                }
                localStorage.setItem('calendar_memos', JSON.stringify(window.memos));
                if (window.generateCalendar) window.generateCalendar();
                if (window.updateWidgets) window.updateWidgets();

            } else {
                // Firebase Mode
                if (!window.userId) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const path = `/artifacts/${appId}/users/${window.userId}/memos`;
                const memoDocRef = doc(db, path, dateKey);

                try {
                    if (shouldDelete) {
                        await deleteDoc(memoDocRef);
                        delete window.reminders[dateKey];
                        showNotification("ì‚­ì œ ì™„ë£Œ", "ë©”ëª¨ì™€ ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", dateKey);
                    } else {
                        await setDoc(memoDocRef, {
                            content: trimmedContent,
                            reminderTime: validTime, 
                            completed: false, 
                            isCustomHoliday: isCustomHoliday,
                            customHolidayName: trimmedHolidayName,
                            updatedAt: new Date(), 
                        }, { merge: false });
                        window.reminders[dateKey] = false; 
                    }
                } catch (error) {
                    console.error("ë©”ëª¨ ì €ì¥/ì‚­ì œ ì˜¤ë¥˜:", error);
                    alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            }
        }

        /**
         * ë¦¬ë§ˆì¸ë” ì™„ë£Œ ì²˜ë¦¬
         */
        async function markReminderAsCompleted(dateKey) {
            window.reminders[dateKey] = true; // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            
            if (useLocalStorage) {
                if(window.memos[dateKey]) {
                    window.memos[dateKey].completed = true;
                    localStorage.setItem('calendar_memos', JSON.stringify(window.memos));
                }
            } else {
                if (!window.userId) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const path = `/artifacts/${appId}/users/${window.userId}/memos`;
                const memoDocRef = doc(db, path, dateKey);
                try {
                    await updateDoc(memoDocRef, { completed: true });
                } catch (error) {
                    console.error("ë¦¬ë§ˆì¸ë” ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                }
            }
        }

        // ==========================================
        // UI Event Listeners
        // ==========================================

        window.openMemoModal = (date) => {
            currentEditingDateKey = window.formatDateKey(date);
            const memoData = window.memos[currentEditingDateKey] || { content: '', reminderTime: '', isCustomHoliday: false, customHolidayName: '' };
            
            modalDateTitle.textContent = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ê¸°ë¡`;
            memoInput.value = memoData.content;
            reminderTimeInput.value = memoData.reminderTime;
            isCustomHolidayInput.checked = memoData.isCustomHoliday;
            customHolidayNameInput.value = memoData.customHolidayName;

            const isDataPresent = memoData.content || memoData.reminderTime || memoData.isCustomHoliday || memoData.customHolidayName;
            deleteMemoBtn.disabled = !isDataPresent;
            
            if (!isDataPresent) {
                deleteMemoBtn.classList.add('opacity-30', 'cursor-not-allowed');
                deleteMemoBtn.classList.remove('hover:bg-red-50');
            } else {
                deleteMemoBtn.classList.remove('opacity-30', 'cursor-not-allowed');
                deleteMemoBtn.classList.add('hover:bg-red-50');
            }
            deleteMemoBtn.style.visibility = 'visible';
            
            memoModal.classList.add('active');
            memoInput.focus();
        };

        function closeMemoModal(save = false) {
            if (save && currentEditingDateKey) {
                const content = memoInput.value;
                const reminderTime = reminderTimeInput.value;
                const isCustomHoliday = isCustomHolidayInput.checked;
                const customHolidayName = customHolidayNameInput.value;
                saveMemoData(currentEditingDateKey, content, reminderTime, isCustomHoliday, customHolidayName);
            }
            memoModal.classList.remove('active');
            currentEditingDateKey = null;
        }
        
        saveMemoBtn.addEventListener('click', () => closeMemoModal(true));
        closeMemoModalBtn.addEventListener('click', () => closeMemoModal(false));
        closeModalCross.addEventListener('click', () => closeMemoModal(false));
        
        deleteMemoBtn.addEventListener('click', () => {
            if (currentEditingDateKey) {
                if(confirm('ì •ë§ ì´ ë‚ ì§œì˜ ëª¨ë“  ê¸°ë¡(ë©”ëª¨, ì•Œë¦¼, ê³µíœ´ì¼ ì„¤ì •)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    saveMemoData(currentEditingDateKey, "", "", false, ""); 
                    closeMemoModal(false); 
                }
            }
        });
        
        memoModal.addEventListener('click', (e) => {
            if (e.target === memoModal) closeMemoModal(false);
        });

        // ìƒë…„ì›”ì¼ ëª¨ë‹¬
        saveBirthdateBtn.addEventListener('click', () => {
            const val = userBirthdateInput.value;
            if (val) saveBirthdate(val);
            else alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        });
        closeBirthdateModalBtn.addEventListener('click', () => birthdateModal.classList.remove('active'));
        profileBtn.addEventListener('click', () => {
            if(window.userBirthdate) userBirthdateInput.value = window.userBirthdate;
            birthdateModal.classList.add('active');
        });

        // ì•Œë¦¼ ê¸°ëŠ¥ (ì»¤ìŠ¤í…€ UI)
        function showNotification(title, body, dateKey) {
            const notification = document.createElement('div');
            notification.className = 'notification-item bg-white p-5 rounded-2xl shadow-2xl border-l-4 border-red-500 w-full relative overflow-hidden';
            notification.id = `notif-${dateKey}`;
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <div class="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4 w-0 flex-1 pt-0.5">
                        <p class="text-base font-bold text-gray-900">${title}</p>
                        <p class="mt-1 text-sm text-gray-500 break-words font-medium">${body}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button type="button" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none close-btn">
                            <span class="sr-only">Close</span>
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            notification.querySelector('.close-btn').addEventListener('click', () => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            });
            notificationBox.appendChild(notification);
            setTimeout(() => {
                if(notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);
        }

        function checkReminders() {
            if (!window.isAuthReady) return;
            const now = new Date();
            const todayKey = window.formatDateKey(now);
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const memoData = window.memos[todayKey];

            if (memoData && memoData.reminderTime && !memoData.completed) {
                if (currentTime === memoData.reminderTime) {
                    showNotification(`â° ì•Œë¦¼: ${memoData.reminderTime}`, memoData.content || 'ì„¤ì •ëœ ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤.', todayKey);
                    markReminderAsCompleted(todayKey); 
                }
            }
        }
        setInterval(checkReminders, 10000);

        // ì´ˆê¸°í™” ë¡œì§
        window.addEventListener('load', async () => {
            if (useLocalStorage) {
                console.log("Firebase config missing. Running in LocalStorage mode.");
                window.userId = 'local-user';
                window.isAuthReady = true;
                setupDataListener();
                setupUserProfile();
                
                // ì•Œë¦¼ ì¶”ê°€ (ì˜µì…˜)
                const titleEl = document.getElementById('currentMonthYear');
                const badge = document.createElement('span');
                badge.id = 'storage-mode-indicator';
                badge.className = 'bg-gray-200 text-gray-600';
                badge.innerText = 'ë¡œì»¬ëª¨ë“œ';
                if(titleEl) titleEl.parentNode.appendChild(badge);

            } else {
                try {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    let initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            window.userId = user.uid;
                            window.isAuthReady = true;
                            setupDataListener();
                            setupUserProfile();
                        } else {
                            window.userId = null;
                            window.isAuthReady = true;
                        }
                    });

                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    // Fallback if init fails
                    window.userId = 'local-user-fallback';
                    window.isAuthReady = true;
                    // Force local storage mode logic roughly
                }
            }
        });
    </script>

    <!-- ìº˜ë¦°ë” ë¡œì§ -->
    <script>
        // í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¬ë ¥ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        let currentMonth = new Date();
        const today = new Date();
        let selectedDate = new Date(); // ì„ íƒëœ ë‚ ì§œ (ê¸°ë³¸ê°’ì€ ì˜¤ëŠ˜)

        // ----------------------------------------------------
        // ** í•œêµ­ ê³ ì • ê¸°ë…ì¼ ëª©ë¡ (ë²•ì • ê³µíœ´ì¼ ì—¬ë¶€ í¬í•¨) **
        const fixedSolarCommemorations = [
            // 1ì›”
            { month: 1, day: 1, name: "ì‹ ì •", isHoliday: true },
            // 2ì›”
            { month: 2, day: 24, name: "2.28 ë¯¼ì£¼ìš´ë™ ê¸°ë…ì¼", isHoliday: false },
            // 3ì›”
            { month: 3, day: 1, name: "ì‚¼ì¼ì ˆ", isHoliday: true },
            // 4ì›”
            { month: 4, day: 5, name: "ì‹ëª©ì¼", isHoliday: false }, // ê³µíœ´ì¼ ì•„ë‹˜
            { month: 4, day: 19, name: "4.19 í˜ëª… ê¸°ë…ì¼", isHoliday: false },
            { month: 4, day: 20, name: "ì¥ì• ì¸ì˜ ë‚ ", isHoliday: false },
            // 5ì›”
            { month: 5, day: 1, name: "ê·¼ë¡œìì˜ ë‚ ", isHoliday: false }, // ë²•ì • ê³µíœ´ì¼ ì•„ë‹˜ (ìœ ê¸‰íœ´ì¼)
            { month: 5, day: 5, name: "ì–´ë¦°ì´ë‚ ", isHoliday: true },
            { month: 5, day: 8, name: "ì–´ë²„ì´ë‚ ", isHoliday: false },
            { month: 5, day: 15, name: "ìŠ¤ìŠ¹ì˜ ë‚ ", isHoliday: false },
            // 6ì›”
            { month: 6, day: 6, name: "í˜„ì¶©ì¼", isHoliday: true },
            { month: 6, day: 10, name: "6.10 ë¯¼ì£¼í•­ìŸ ê¸°ë…ì¼", isHoliday: false },
            { month: 6, day: 25, name: "6.25 ì „ìŸ ê¸°ë…ì¼", isHoliday: false },
            // 7ì›”
            { month: 7, day: 17, name: "ì œí—Œì ˆ", isHoliday: false }, // ê³µíœ´ì¼ ì œì™¸ë¨
            // 8ì›”
            { month: 8, day: 15, name: "ê´‘ë³µì ˆ", isHoliday: true },
            // 10ì›”
            { month: 10, day: 1, name: "êµ­êµ°ì˜ ë‚ ", isHoliday: false }, // ê¸°ë³¸ì€ í‰ì¼ (ì—°ë„ë³„ ë°ì´í„°ì—ì„œ ì„ì‹œê³µíœ´ì¼ ì²˜ë¦¬)
            { month: 10, day: 3, name: "ê°œì²œì ˆ", isHoliday: true },
            { month: 10, day: 9, name: "í•œê¸€ë‚ ", isHoliday: true },
            { month: 10, day: 24, name: "ìœ ì—”ì˜ ë‚ ", isHoliday: false },
            // 11ì›”
            { month: 11, day: 3, name: "í•™ìƒë…ë¦½ìš´ë™ê¸°ë…ì¼", isHoliday: false },
            { month: 11, day: 11, name: "ë†ì—…ì¸ì˜ ë‚ ", isHoliday: false },
            // 12ì›”
            { month: 12, day: 25, name: "ì„±íƒ„ì ˆ", isHoliday: true },
        ];

        // ** í•œêµ­ ë³€ë™/ìŒë ¥ ê³µíœ´ì¼ ë° ê¸°ë…ì¼ ëª©ë¡ **
        // ëŒ€ë¶€ë¶„ì˜ ìŒë ¥ ê¸°ë…ì¼ì€ ê³µíœ´ì¼ì´ë¯€ë¡œ isHoliday: trueë¡œ ì„¤ì •
        const yearSpecificCommemorations = [
            // 2024ë…„
            { year: 2024, month: 2, day: 9, name: "ì„¤ë‚  ì—°íœ´", isHoliday: true },
            { year: 2024, month: 2, day: 10, name: "ì„¤ë‚ ", isHoliday: true },
            { year: 2024, month: 2, day: 11, name: "ì„¤ë‚  ì—°íœ´", isHoliday: true },
            { year: 2024, month: 2, day: 12, name: "ì„¤ë‚  ì—°íœ´(ëŒ€ì²´)", isHoliday: true },
            { year: 2024, month: 4, day: 10, name: "êµ­íšŒì˜ì› ì„ ê±°ì¼", isHoliday: true },
            { year: 2024, month: 5, day: 5, name: "ì–´ë¦°ì´ë‚ ", isHoliday: true },
            { year: 2024, month: 5, day: 6, name: "ì–´ë¦°ì´ë‚  ëŒ€ì²´íœ´ì¼", isHoliday: true },
            { year: 2024, month: 5, day: 15, name: "ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ ", isHoliday: true },
            { year: 2024, month: 9, day: 16, name: "ì¶”ì„ ì—°íœ´", isHoliday: true },
            { year: 2024, month: 9, day: 17, name: "ì¶”ì„", isHoliday: true },
            { year: 2024, month: 9, day: 18, name: "ì¶”ì„ ì—°íœ´", isHoliday: true },
            { year: 2024, month: 10, day: 1, name: "êµ­êµ°ì˜ ë‚  (ì„ì‹œê³µíœ´ì¼)", isHoliday: true }, // 2024ë…„ í•œì •
            // 2025ë…„
            { year: 2025, month: 1, day: 28, name: "ì„¤ë‚  ì—°íœ´", isHoliday: true },
            { year: 2025, month: 1, day: 29, name: "ì„¤ë‚ ", isHoliday: true },
            { year: 2025, month: 1, day: 30, name: "ì„¤ë‚  ì—°íœ´", isHoliday: true },
            { year: 2025, month: 3, day: 3, name: "ì‚¼ì¼ì ˆ ëŒ€ì²´íœ´ì¼", isHoliday: true },
            { year: 2025, month: 5, day: 5, name: "ì–´ë¦°ì´ë‚  / ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ ", isHoliday: true }, 
            { year: 2025, month: 5, day: 6, name: "ë¶€ì²˜ë‹˜/ì–´ë¦°ì´ë‚  ëŒ€ì²´íœ´ì¼", isHoliday: true },
            { year: 2025, month: 10, day: 5, name: "ì¶”ì„ ì—°íœ´", isHoliday: true },
            { year: 2025, month: 10, day: 6, name: "ì¶”ì„", isHoliday: true },
            { year: 2025, month: 10, day: 7, name: "ì¶”ì„ ì—°íœ´", isHoliday: true },
            { year: 2025, month: 10, day: 8, name: "ì¶”ì„ ëŒ€ì²´íœ´ì¼", isHoliday: true },
            // 2026ë…„
            { year: 2026, month: 2, day: 17, name: "ì„¤ë‚  ì—°íœ´", isHoliday: true },
            { year: 2026, month: 2, day: 18, name: "ì„¤ë‚ ", isHoliday: true },
            { year: 2026, month: 2, day: 19, name: "ì„¤ë‚  ì—°íœ´", isHoliday: true },
            { year: 2026, month: 5, day: 24, name: "ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚ ", isHoliday: true },
            { year: 2026, month: 5, day: 25, name: "ë¶€ì²˜ë‹˜ ì˜¤ì‹  ë‚  ëŒ€ì²´íœ´ì¼", isHoliday: true },
            { year: 2026, month: 9, day: 25, name: "ì¶”ì„ ì—°íœ´", isHoliday: true },
            { year: 2026, month: 9, day: 26, name: "ì¶”ì„", isHoliday: true },
            { year: 2026, month: 9, day: 27, name: "ì¶”ì„ ì—°íœ´", isHoliday: true },
        ];


        /**
         * ì£¼ì–´ì§„ ì£¼ì°¨(1=ì²«ì§¸ ì£¼)ì™€ ìš”ì¼(0=ì¼, 6=í† )ì— í•´ë‹¹í•˜ëŠ” ë‚ ì§œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
         */
        function getNthDayOfWeekInMonth(year, month, weekIndex, dayOfWeek) {
            const date = new Date(year, month - 1, 1);
            let count = 0;
            let targetDay = null;

            while (date.getMonth() === month - 1) {
                if (date.getDay() === dayOfWeek) {
                    count++;
                    if (count === weekIndex) {
                        targetDay = date.getDate();
                        break;
                    }
                }
                date.setDate(date.getDate() + 1);
            }
            return targetDay;
        }

        /**
         * ì£¼ì–´ì§„ ë‚ ì§œê°€ ê¸°ë…ì¼ì¸ì§€ í™•ì¸í•˜ê³  ê¸°ë…ì¼ ì •ë³´ ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * ë°˜í™˜ê°’: { name: string, isHoliday: boolean } ë˜ëŠ” null
         */
        function getCommemoration(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // 1-based
            const day = date.getDate();
            
            let commemoration = null;

            // 1. ê³ ì • ì–‘ë ¥ ë‚ ì§œ í™•ì¸
            const fixedComm = fixedSolarCommemorations.find(c => 
                c.month === month && c.day === day
            );

            if (fixedComm) {
                commemoration = { name: fixedComm.name, isHoliday: fixedComm.isHoliday };
            }

            // 2. ì—°ë„ë³„/ìŒë ¥ ë‚ ì§œ í™•ì¸
            const yearSpecific = yearSpecificCommemorations.find(c => 
                c.year === year && c.month === month && c.day === day
            );
            
            if (yearSpecific) {
                // ì´ë¯¸ ê¸°ë…ì¼ì´ ìˆë‹¤ë©´ ë³‘í•©
                if (commemoration) {
                    if (!commemoration.name.includes(yearSpecific.name)) {
                        commemoration.name += ` / ${yearSpecific.name}`;
                    }
                    // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ íœ´ì¼ì´ë©´ íœ´ì¼ë¡œ ì²˜ë¦¬
                    commemoration.isHoliday = commemoration.isHoliday || yearSpecific.isHoliday;
                } else {
                    commemoration = { name: yearSpecific.name, isHoliday: yearSpecific.isHoliday };
                }
            }


            // 3. ë³€ë™ ë‚ ì§œ ê¸°ë…ì¼ (ëª¨ë‘ í‰ì¼ ê¸°ë…ì¼)
            const variableCommemorations = [
                { month: 1, weekIndex: 3, dayOfWeek: 2, name: "ì •ë³´ë³´í˜¸ì˜ ë‚ ", isHoliday: false },
                { month: 3, weekIndex: 3, dayOfWeek: 5, name: "ìƒê³µì˜ ë‚ ", isHoliday: false },
                { month: 5, weekIndex: 3, dayOfWeek: 1, name: "ì„±ë…„ì˜ ë‚ ", isHoliday: false },
            ];

            for (const vc of variableCommemorations) {
                if (vc.month === month) {
                    const targetDay = getNthDayOfWeekInMonth(year, month, vc.weekIndex, vc.dayOfWeek);
                    if (targetDay === day) {
                        if (commemoration) {
                            if (!commemoration.name.includes(vc.name)) {
                                commemoration.name += ` / ${vc.name}`;
                            }
                            commemoration.isHoliday = commemoration.isHoliday || vc.isHoliday;
                        } else {
                            commemoration = { name: vc.name, isHoliday: vc.isHoliday };
                        }
                        break;
                    }
                }
            }

            return commemoration;
        }

        /**
         * ì£¼ì–´ì§„ ë‚ ì§œì— ëŒ€í•œ ìŒë ¥ ë‚ ì§œë¥¼ ë¬¸ìì—´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function getLunarDate(date) {
            try {
                const lunarDate = new Intl.DateTimeFormat('ko-KR-u-ca-chinese', {
                    month: 'numeric',
                    day: 'numeric',
                }).format(date);
                return lunarDate;

            } catch (e) {
                console.error("ìŒë ¥ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                return ' - ';
            }
        }

        /**
         * ë‚˜ì´ë¥¼ ê³„ì‚°í•˜ì—¬ í—¤ë”ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateAgeDisplay() {
            const ageDisplay = document.getElementById('ageDisplay');
            if (!window.userBirthdate) {
                ageDisplay.classList.add('hidden');
                return;
            }

            const birthDate = new Date(window.userBirthdate);
            const currentYear = currentMonth.getFullYear();
            const currentMonthIndex = currentMonth.getMonth(); // 0-11
            
            // í˜„ì¬ ë³´ê³  ìˆëŠ” ë‹¬ì˜ 1ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const targetDate = new Date(currentYear, currentMonthIndex, 1);

            // í•œêµ­ ë‚˜ì´ (ì„¸ëŠ” ë‚˜ì´): í˜„ì¬ì—°ë„ - ì¶œìƒì—°ë„ + 1
            const koreanAge = currentYear - birthDate.getFullYear() + 1;

            // ë§Œ ë‚˜ì´
            let internationalAge = currentYear - birthDate.getFullYear();
            const m = currentMonthIndex - birthDate.getMonth();
            // ìƒì¼ì´ ì•„ì§ ì•ˆ ì§€ë‚¬ìœ¼ë©´ -1 (ì¼ ë‹¨ìœ„ ë¹„êµëŠ” í•´ë‹¹ ì›” 1ì¼ ê¸°ì¤€ì´ë¼ ë‹¨ìˆœí™”)
            if (m < 0) { 
                internationalAge--;
            } 

            ageDisplay.textContent = `ë§Œ ${internationalAge}ì„¸ (í•œêµ­ë‚˜ì´ ${koreanAge}ì„¸)`;
            ageDisplay.classList.remove('hidden');
        }

        /**
         * ë‹¬ë ¥ í—¤ë”(í˜„ì¬ ì—°ë„ì™€ ì›”)ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        window.updateHeader = function() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth() + 1;
            document.getElementById('currentMonthYear').textContent = `${year}ë…„ ${month}ì›”`;
            
            // ë‚˜ì´ ì •ë³´ ì—…ë°ì´íŠ¸
            updateAgeDisplay();
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ì˜¤ëŠ˜ ë‚ ì§œ ì´ë™)
        window.goToday = function() {
            currentMonth = new Date();
            selectedDate = new Date();
            window.updateHeader();
            window.generateCalendar();
            window.updateWidgets();
        }

        /**
         * ë‹¬ë ¥ì—ì„œ ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ìœ„ì ¯ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function selectDate(date) {
            selectedDate = new Date(date); // ìƒˆ ë‚ ì§œë¡œ ì—…ë°ì´íŠ¸
            window.generateCalendar(); // ì„ íƒëœ ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸ë¥¼ ìœ„í•´ ë‹¬ë ¥ ì¬ìƒì„±
            window.updateWidgets(); // ìœ„ì ¯ ì—…ë°ì´íŠ¸
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.triggerMemoModal = function() {
            if (window.isAuthReady) {
                window.openMemoModal(selectedDate);
            } else {
                alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            }
        }

        /**
         * ì£¼ì–´ì§„ ì›”ì— ëŒ€í•œ ë‹¬ë ¥ ê·¸ë¦¬ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         */
        window.generateCalendar = function() { 
            const grid = document.getElementById('calendarGrid');
            if(!grid) return;
            grid.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth(); // 0-based

            const firstDayOfMonth = new Date(year, month, 1);
            const startingDayOfWeek = firstDayOfMonth.getDay(); 
            const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

            // ì´ì „ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ì§œë¥¼ ì±„ì›ë‹ˆë‹¤ (ë¹ˆ ì…€).
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'bg-transparent'; 
                grid.appendChild(emptyCell);
            }

            // í˜„ì¬ ì›”ì˜ ë‚ ì§œë¥¼ ì±„ì›ë‹ˆë‹¤.
            for (let date = 1; date <= lastDateOfMonth; date++) {
                const day = new Date(year, month, date);
                const dayOfWeek = day.getDay();
                
                // 1. ë©”ëª¨/ì»¤ìŠ¤í…€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const dateKey = window.formatDateKey(day);
                const memoData = window.memos[dateKey] || {};
                const hasMemo = !!memoData.content;
                const hasReminder = !!memoData.reminderTime;
                
                // 2. ì‹œìŠ¤í…œ ê¸°ë…ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const comm = getCommemoration(day);
                let commemorationName = comm ? comm.name : null;
                let isHoliday = comm ? comm.isHoliday : false;

                // 3. ì»¤ìŠ¤í…€ ê³µíœ´ì¼ ë° ì´ë¦„ ë¡œì§ ì ìš©
                if (memoData.isCustomHoliday) {
                    isHoliday = true; // ì»¤ìŠ¤í…€ ì„¤ì •ì´ ìˆìœ¼ë©´ íœ´ì¼ë¡œ ê°•ì œ
                }
                
                if (memoData.customHolidayName) {
                    if (commemorationName) {
                        // ê¸°ì¡´ ì´ë¦„ ë’¤ì— ì¶”ê°€í•˜ê±°ë‚˜, ë³„ë„ë¡œ í‘œì‹œí•  ìˆ˜ ìˆìŒ. ì—¬ê¸°ì„  ë³‘í•©
                        commemorationName = `${commemorationName} / ${memoData.customHolidayName}`;
                    } else {
                        commemorationName = memoData.customHolidayName;
                    }
                }

                const cell = document.createElement('div');
                cell.className = 'day-cell rounded-xl';

                let textColor = 'text-gray-800';
                
                // ìƒ‰ìƒ ë¡œì§: ë²•ì •ê³µíœ´ì¼(isHoliday=true) ë˜ëŠ” ì¼ìš”ì¼ì€ ë¹¨ê°„ìƒ‰
                if (isHoliday || dayOfWeek === 0) { 
                    textColor = 'text-red-500';
                } else if (dayOfWeek === 6) { 
                    textColor = 'text-blue-500';
                }

                const isToday = day.toDateString() === today.toDateString();
                const isSelected = day.toDateString() === selectedDate.toDateString();

                if (isToday) {
                    cell.classList.add('today');
                }
                
                if (isSelected) {
                    cell.classList.add('selected-date');
                    if (!isToday) {
                        cell.classList.remove('today'); 
                    }
                }
                
                if (!isToday && !isSelected) {
                    cell.classList.add('bg-white', 'border-transparent');
                }

                const lunarDay = getLunarDate(day);
                const simpleLunar = lunarDay.replace(/(\d{4}ë…„ )?/, ''); 

                let iconsHtml = '';
                if (hasMemo) {
                    iconsHtml += '<div class="memo-dot" title="ë©”ëª¨ ìˆìŒ"></div>';
                }
                if (hasReminder) {
                    iconsHtml += '<div class="alarm-icon" title="ì•Œë¦¼ ì„¤ì •ë¨"></div>';
                }
                const memoIcons = iconsHtml ? `<div class="memo-icons">${iconsHtml}</div>` : '';

                // ê¸°ë…ì¼ ë¼ë²¨ ìƒ‰ìƒ: ê³µíœ´ì¼ì´ë©´ ë¹¨ê°„ìƒ‰, ì•„ë‹ˆë©´ íšŒìƒ‰
                const labelColor = isHoliday ? 'bg-red-400' : 'bg-gray-300';
                const labelTitle = commemorationName || '';
                const labelHtml = commemorationName 
                    ? `<div class="w-1.5 h-1.5 rounded-full ${labelColor} mt-1" title="${labelTitle}"></div>` 
                    : '<div class="w-1.5 h-1.5 mt-1"></div>';

                cell.innerHTML = `
                    ${memoIcons}
                    <div class="flex-grow flex flex-col justify-between items-center h-full py-1">
                        <div class="font-bold ${textColor} text-xl sm:text-2xl leading-none">
                            ${date}
                        </div>
                        <div class="text-xs sm:text-sm text-gray-400 font-medium leading-none tracking-tighter">
                            ${simpleLunar}
                        </div>
                        ${labelHtml}
                        ${commemorationName ? `<div class="hidden sm:block text-xs leading-none mt-1 truncate w-full text-center ${isHoliday ? 'text-red-500' : 'text-gray-500'}">${commemorationName.split('/')[0]}</div>` : ''}
                    </div>
                `;

                cell.addEventListener('click', () => selectDate(day));
                cell.addEventListener('dblclick', () => {
                     window.triggerMemoModal();
                });

                grid.appendChild(cell);
            }
        };

        /**
         * ë‹¤ìŒìœ¼ë¡œ ë‹¤ê°€ì˜¤ëŠ” ê¸°ë…ì¼/ê³µíœ´ì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
         */
        function findNextCommemoration(startDate) {
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0); 

            const currentYear = start.getFullYear();
            const yearsToCheck = [currentYear, currentYear + 1];

            let futureCommemorations = [];

            for (const year of yearsToCheck) {
                // 1. ê³ ì • ê¸°ë…ì¼
                for (const c of fixedSolarCommemorations) {
                    const date = new Date(year, c.month - 1, c.day);
                    if (date >= start) {
                        futureCommemorations.push({ date: date, name: c.name, isHoliday: c.isHoliday });
                    }
                }

                // 2. ì—°ë„ë³„ ê¸°ë…ì¼
                for (const c of yearSpecificCommemorations) {
                    if (c.year === year) {
                        const date = new Date(c.year, c.month - 1, c.day);
                        if (date >= start) {
                            futureCommemorations.push({ date: date, name: c.name, isHoliday: c.isHoliday });
                        }
                    }
                }
                
                // 3. ë³€ë™ ê¸°ë…ì¼ ì¶”ê°€
                const variableCommemorations = [
                    { month: 1, weekIndex: 3, dayOfWeek: 2, name: "ì •ë³´ë³´í˜¸ì˜ ë‚ ", isHoliday: false },
                    { month: 3, weekIndex: 3, dayOfWeek: 5, name: "ìƒê³µì˜ ë‚ ", isHoliday: false },
                    { month: 5, weekIndex: 3, dayOfWeek: 1, name: "ì„±ë…„ì˜ ë‚ ", isHoliday: false },
                ];
                for (const vc of variableCommemorations) {
                     const targetDay = getNthDayOfWeekInMonth(year, vc.month, vc.weekIndex, vc.dayOfWeek);
                     if (targetDay) {
                         const date = new Date(year, vc.month - 1, targetDay);
                         if (date >= start) {
                             futureCommemorations.push({ date: date, name: vc.name, isHoliday: vc.isHoliday });
                         }
                     }
                }
            }
            
            // 4. ì»¤ìŠ¤í…€ ê¸°ë…ì¼ ì¶”ê°€ ë¡œì§ (í˜„ì¬ ë¡œë“œëœ ë©”ëª¨ ê¸°ë°˜)
            // ì£¼ì˜: ë©”ëª¨ëŠ” í˜„ì¬ ë¡œì»¬ì— ë¡œë“œëœ window.memosë§Œ í™•ì¸í•˜ë¯€ë¡œ, 
            // ì‹¤ì œë¡œëŠ” ì „ì²´ DB ì¿¼ë¦¬ê°€ ì•„ë‹ˆì§€ë§Œ ì‚¬ìš©ì UXìƒ ë³´ì´ëŠ” ë²”ìœ„ ë‚´ì—ì„œëŠ” ì‘ë™
            for(const [dateKey, data] of Object.entries(window.memos)) {
                if(data.isCustomHoliday || data.customHolidayName) {
                    const [y, m, d] = dateKey.split('-').map(Number);
                    const date = new Date(y, m-1, d);
                    if(date >= start) {
                         const name = data.customHolidayName || "ì‚¬ìš©ì ì§€ì • ê¸°ë…ì¼";
                         // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ê°„ë‹¨íˆ ì²´í¬
                         futureCommemorations.push({ date: date, name: name, isHoliday: data.isCustomHoliday });
                    }
                }
            }

            futureCommemorations.sort((a, b) => a.date - b.date);
            
            // ë³‘í•© ë¡œì§
            if (futureCommemorations.length > 1 && futureCommemorations[0].date.toDateString() === futureCommemorations[1].date.toDateString()) {
                if (!futureCommemorations[0].name.includes(futureCommemorations[1].name)) {
                    futureCommemorations[0].name += ` / ${futureCommemorations[1].name}`;
                }
                // í•˜ë‚˜ë¼ë„ íœ´ì¼ì´ë©´ íœ´ì¼ ì²˜ë¦¬
                futureCommemorations[0].isHoliday = futureCommemorations[0].isHoliday || futureCommemorations[1].isHoliday;
                futureCommemorations.splice(1, 1); 
            }

            return futureCommemorations.length > 0 ? futureCommemorations[0] : null;
        }


        /**
         * ìœ„ì ¯ ì„¹ì…˜ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        window.updateWidgets = function() { 
            const date = selectedDate; 
            const dayOfWeekNumeric = date.getDay(); 
            const dateKey = window.formatDateKey(date);
            const memoData = window.memos[dateKey] || {};
            
            document.getElementById('todaySolarDate').textContent = 
                `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            
            const lunarDateDisplay = getLunarDate(date);
            document.getElementById('todayLunarDate').textContent = `${date.getFullYear()}ë…„ â€¢ ìŒë ¥ ${lunarDateDisplay}`;

            // ê¸°ë…ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì‹œìŠ¤í…œ + ì»¤ìŠ¤í…€)
            const comm = getCommemoration(date);
            let commemorationName = comm ? comm.name : null;
            let isHoliday = comm ? comm.isHoliday : false;
            
            if (memoData.isCustomHoliday) isHoliday = true;
            if (memoData.customHolidayName) {
                commemorationName = commemorationName 
                    ? `${commemorationName} / ${memoData.customHolidayName}` 
                    : memoData.customHolidayName;
            }
            
            const todayCommemorationElement = document.getElementById('todayCommemoration');
            
            let statusText = '';
            let statusClass = '';
            
            if (commemorationName) {
                statusText = `${commemorationName}`;
                // ê³µíœ´ì¼ì´ë©´ ë¹¨ê°„ìƒ‰, ì¼ë°˜ ê¸°ë…ì¼ì´ë©´ ê²€ì€ìƒ‰/íšŒìƒ‰
                statusClass = isHoliday ? 'text-red-500' : 'text-gray-700';
            } else if (dayOfWeekNumeric === 0) {
                statusText = 'ì¼ìš”ì¼';
                statusClass = 'text-red-500';
            } else if (dayOfWeekNumeric === 6) {
                statusText = 'í† ìš”ì¼';
                statusClass = 'text-blue-500';
            } else {
                statusText = 'í‰ì¼';
                statusClass = 'text-gray-400';
            }
            
            todayCommemorationElement.textContent = statusText;
            todayCommemorationElement.className = `mt-3 text-lg sm:text-xl font-bold ${statusClass}`;
            
            // 1-b. ë©”ëª¨ ì—…ë°ì´íŠ¸
            const memoContent = memoData.content || 'ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
            const memoElement = document.getElementById('selectedDateMemo');
            memoElement.textContent = memoContent;
            
            if (!memoData.content) {
                memoElement.classList.add('text-gray-400', 'italic');
                memoElement.classList.remove('text-gray-700');
            } else {
                memoElement.classList.remove('text-gray-400', 'italic');
                memoElement.classList.add('text-gray-700');
            }
            
            const reminderTime = memoData.reminderTime;
            const reminderText = reminderTime ? `â° ì•Œë¦¼ ì˜ˆì •: ${reminderTime}` : '';
            document.getElementById('selectedDateReminder').textContent = reminderText;

            // 2. ë‹¤ìŒ ê³µíœ´ì¼/ê¸°ë…ì¼ ì—…ë°ì´íŠ¸
            const nextCommemoration = findNextCommemoration(date); 
            const nextCommemorationNameElement = document.getElementById('nextCommemorationName');
            const nextCommemorationDateElement = document.getElementById('nextCommemorationDate');
            const dDayElement = document.getElementById('dDayCount');
            
            if (nextCommemoration) {
                nextCommemorationNameElement.textContent = nextCommemoration.name;
                nextCommemorationNameElement.className = nextCommemoration.isHoliday ? 'text-gray-900 text-3xl sm:text-5xl font-extrabold mb-3 leading-tight' : 'text-gray-700 text-3xl sm:text-5xl font-extrabold mb-3 leading-tight';

                const dDate = nextCommemoration.date;
                nextCommemorationDateElement.textContent = 
                    `${dDate.getFullYear()}ë…„ ${dDate.getMonth() + 1}ì›” ${dDate.getDate()}ì¼`;
                
                const diffTime = Math.abs(dDate - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if(dDate.toDateString() === date.toDateString()) {
                     dDayElement.textContent = "Today";
                     dDayElement.className = "bg-red-500 text-white px-4 py-1.5 rounded-full font-bold text-sm";
                } else {
                     dDayElement.textContent = `D-${diffDays}`;
                     const badgeColor = nextCommemoration.isHoliday ? "bg-red-100 text-red-600" : "bg-gray-100 text-gray-600";
                     dDayElement.className = `${badgeColor} px-4 py-1.5 rounded-full font-bold text-sm`;
                }
                dDayElement.style.display = 'inline-block';

            } else {
                nextCommemorationNameElement.textContent = 'ì˜ˆì •ëœ íœ´ì¼ ì—†ìŒ';
                nextCommemorationDateElement.textContent = '-';
                dDayElement.style.display = 'none';
            }
        }

        /**
         * ë‹¬ë ¥ ì›”ì„ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
         */
        function changeMonth(monthChange) {
            currentMonth.setMonth(currentMonth.getMonth() + monthChange);
            // ë‚ ì§œ ê³„ì‚° ì¬ì¡°ì • (ì›”ë§ ë¬¸ì œ ë°©ì§€)
            // ex: 1ì›” 31ì¼ì—ì„œ 2ì›”ë¡œ ê°€ë©´ 3ì›” 3ì¼ì´ ë  ìˆ˜ ìˆìŒ. ë‹¬ë ¥ ë³´ê¸°ì—” 1ì¼ë¡œ ì„¤ì •í•˜ëŠ”ê²Œ ì•ˆì „
            // í•˜ì§€ë§Œ ì—¬ê¸°ì„  ìº˜ë¦°ë” ë·°ìš© Date ê°ì²´ì´ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            
            window.updateHeader();
            window.generateCalendar();
            window.updateWidgets();
        }

        // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        window.addEventListener('load', function() {
            // ì´ˆê¸° ë‹¬ë ¥ ìƒì„± (Firebase ë°ì´í„°ê°€ ë¡œë“œëœ í›„ì—ë„ generateCalendarì™€ updateWidgetsëŠ” ë‹¤ì‹œ í˜¸ì¶œë¨)
            window.updateHeader();
            if(window.generateCalendar) window.generateCalendar();
            if(window.updateWidgets) window.updateWidgets();

            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
        });

    </script>
</body>
</html>